<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Демо ставки</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: auto;
            padding: 20px;
        }

        input,
        button {
            margin: 5px 0;
            padding: 8px;
            width: 100%;
        }

        .bet-btn {
            background: purple;
            color: white;
            border: none;
            cursor: pointer;
        }

        .logout-btn {
            background: red;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2 id="status">Вход / Регистрация</h2>
    <div id="auth-section">
        <input id="email" placeholder="Email">
        <input id="password" type="password" placeholder="Пароль">
        <button onclick="login()">Войти</button>
        <button onclick="register()">Регистрация</button>
    </div>

    <div id="app-section" style="display:none;">
        <h3>Баланс: <span id="balance">0</span></h3>
        <button class="bet-btn" onclick="placeBet()">Сделать ставку</button>
        <button class="logout-btn" onclick="logout()">Выйти</button>
        <h4>История ставок:</h4>
        <ul id="history"></ul>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD_BbeGYrJ1EVg9cPjjj-XmvcwO9cIIMec",
            authDomain: "trade-14bf9.firebaseapp.com",
            databaseURL: "https://trade-14bf9-default-rtdb.firebaseio.com",
            projectId: "trade-14bf9",
            storageBucket: "trade-14bf9.firebasestorage.app",
            messagingSenderId: "555237498779",
            appId: "1:555237498779:web:d2146e3875425b15860b3e",
            measurementId: "G-BY2LWR40N0"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;

        // Отслеживаем состояние авторизации
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('app-section').style.display = 'block';
                document.getElementById('status').textContent = 'Добро пожаловать!';

                const userRef = db.collection('users').doc(user.uid);
                const snap = await userRef.get();

                if (!snap.exists) {
                    // Новый пользователь — стартовый баланс 100
                    await userRef.set({ balance: 100, history: [] });
                    updateUI({ balance: 100, history: [] });
                } else {
                    // Просто используем существующие данные
                    const data = snap.data();
                    // Если balance нет, установим 100
                    if (data.balance == null) data.balance = 100;
                    if (!Array.isArray(data.history)) data.history = [];
                    updateUI(data);
                }
            } else {
                currentUser = null;
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('app-section').style.display = 'none';
                document.getElementById('status').textContent = 'Вход / Регистрация';
            }
        });


        // Регистрация
        async function register() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;

            if (!email || !pass) return alert("Введите email и пароль");

            try {
                await auth.createUserWithEmailAndPassword(email, pass);
            } catch (err) {
                alert("Ошибка регистрации: " + err.message);
            }
        }

        // Вход
        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;

            if (!email || !pass) return alert("Введите email и пароль");

            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (err) {
                alert("Ошибка входа: " + err.message);
            }
        }

        // Выход
        function logout() {
            auth.signOut();
        }

        // Сделать ставку
        async function placeBet() {
            const userRef = db.collection('users').doc(currentUser.uid);
            const snap = await userRef.get();
            let { balance, history } = snap.data();

            if (balance <= 0) {
                alert("Недостаточно средств!");
                return;
            }

            const win = Math.random() < 0.5;
            const newBalance = win ? balance * 2 : Math.max(balance - 10, 0);
            const result = win ? "Выигрыш x2" : "Проигрыш -10";

            const entry = { date: new Date().toLocaleString(), result, balance: newBalance };
            history.push(entry);

            await userRef.update({ balance: newBalance, history: history });
            updateUI({ balance: newBalance, history: history });
        }

        // Обновляем UI
        function updateUI(data) {
            document.getElementById('balance').textContent = data.balance;
            const historyList = document.getElementById('history');
            historyList.innerHTML = '';
            data.history.forEach(h => {
                const li = document.createElement('li');
                li.textContent = `${h.date}: ${h.result} (Баланс: ${h.balance})`;
                historyList.appendChild(li);
            });
        }
    </script>
</body>

</html>